---
title: "Analysis of Google Play Store Apps"
author: "Minhaz Khan"
date: "January 12, 2019"
output: html_document
---

```{r}
library(tidyverse)
library(lubridate)
library(klaR)
library(broom)
library(tidytext)
```


##Reading in the Data
```{r}
apps = read_csv("googleplaystore.csv")
head(apps)
```

##Average rating of each genre

Filtered out the missing rating values and stored them in a new data frame which we will use for the rest of the analysis.

```{r}
apps %>% filter(Rating != 'NaN') -> true_apps
true_apps %>% group_by(Genres) %>% summarise(avg=mean(Rating))
```
Getting a glimpse of the data to convert the numerical data from being characters
```{r}
glimpse(true_apps)
```

##Seperating Numerical and Character values from columns
```{r}
true_apps %>% filter(Size != "Varies with device") %>% 
  separate(Size, c("Size","Type"), sep = -1, convert = TRUE) %>% 
  separate(Installs, c("Installs","Symbol"), sep = -1, convert = TRUE) %>% drop_na() -> apps2

apps2$Price = parse_number(apps2$Price)

apps2$Symbol = NULL
apps2$Category = NULL
apps2$`Current Ver`= NULL
```
Removed Symbol because it was just character; removed category because it was the same as genre, removed Current Version because it isn't as necessary as when the app was last updated. Kept Android version because exploring app compatibility with OS might be interesting.

##Converting character values to numeric
```{r}
apps2$Installs = as.numeric(gsub(",","",apps2$Installs))
apps2$Size = as.numeric(as.character(apps2$Size))
glimpse(apps2)
```
Converting dates
```{r}

apps2$`Last Updated` = gsub(",","",apps2$`Last Updated`)
apps2 %>% mutate(`Last Update` = mdy(`Last Updated`)) -> apps2

```
Attempting to factor prices as paid or not:
```{r}
apps2 %>% mutate(Price = case_when(
                              Price == 0 ~ Price, 
                              Price > 0 ~ Price/Price,
                              TRUE ~ NA_real_)) -> apps2
#apps2 %>% factor(Price, levels = 1:2, labels = "Paid") %>% select(Price)

```

Converting kilobyte app size
```{r}
apps2 %>% mutate(SIZE = case_when(
                              Type == "M" ~ Size, 
                              Type == "k" ~ Size/1024,
                              TRUE ~ NA_real_)) -> apps2

apps2 %>% separate_rows(Genres, sep = ";", convert = FALSE) -> apps2

apps2$Size = NULL
apps2$Type = NULL
```



##Some Descriptive Statistics
```{r}
apps2 %>% group_by(Genres) %>% summarise(m=mean(Rating))
(apps_aov = aov(Rating~SIZE+Installs+Price+Reviews+Genres+`Content Rating`+`Last Update`, data = apps2))

summary(apps_aov)

```

##Graphing the relationship between the rating and other numerical factors
```{r}
ggplot(apps2, aes(Rating,log(Installs)))+geom_point()+xlim(0,5)+ylim(min(log(apps2$Installs)),max(log(apps2$Installs)))+geom_smooth()
ggplot(apps2, aes(Rating,log(Reviews)))+geom_point()+xlim(0,5)+ylim(min(log(apps2$Reviews)),max(log(apps2$Reviews)))+geom_smooth()
ggplot(apps2, aes(Rating,SIZE))+geom_point()+xlim(0,5)+ylim(min(apps2$SIZE),max(apps2$SIZE))+geom_smooth()
ggplot(apps2, aes(Rating,Price))+geom_point()+xlim(0,5)+ylim(min(apps2$Price),max(apps2$Price))+geom_smooth()
#appplot + ylim(0,5) + xlim(1,1.0e+09)
#appplot + ylim(0,5)
```
Effective rating goes down after reaching its peak in proportion to the categories above as expected. This highlights the fact that good apps exist but doesn't get much attention or the ratings and reviews are fabricated.

## Regression Models

#Fixing duplicate Genres under similar terms
```{r}
apps2 %>% mutate(Genres = case_when(
                              Genres == "Educational" ~ "Education", 
                              Genres == "Music & Audio" ~ "Music",
                              Genres == "Music & Video" ~ "Music",
                              TRUE ~ Genres)) -> apps2
```


```{r}
appreg = lm(Rating~SIZE+I(log(Installs))+I(log(Reviews))+`Last Update`+Genres+Price, data = apps2, weights = Installs)
summary(appreg)
```
Taking the log of Installs and Reviews and weighing it with the Installs helped increase the R squared to about 53%
```{r}
ggplot(appreg, aes(x=.fitted, y=.resid))+geom_point()+geom_smooth()
```

##Kmeans for Genres

```{r}
genres = kmodes(apps2[,c(3:7,11)], modes = 10, iter.max = 10, weighted = FALSE)

plot(jitter(apps2$Rating),col = genres$cluster)
points(genres$modes, col = 1:5, pch = 8)
genres$modes
genres$cluster

```
```{r}
apps2 %>% mutate(cluster=genres$cluster) -> apps2
```
```{r}
clustapp = genres$modes
```
```{r}
clustapp %>% distinct(Genres)
clustapp$Genres[2]
```
```{r}
apps2 %>% group_by(cluster, Genres) %>% count() %>% summarise(m=max(n)) %>% summarise(mm=max(m))  
```
```{r}
apps2 %>% mutate(True_Genre = case_when(
                                         cluster == 1 & Genres != clustapp$Genres[1] ~ clustapp$Genres[1],
                                         cluster == 2 & Genres != clustapp$Genres[2] ~ clustapp$Genres[2],
                                         cluster == 3 & Genres != clustapp$Genres[3] ~ clustapp$Genres[3],
                                         cluster == 4 & Genres != clustapp$Genres[4] ~ clustapp$Genres[4],
                                         cluster == 5 & Genres != clustapp$Genres[5] ~ clustapp$Genres[5],
                                         cluster == 6 & Genres != clustapp$Genres[6] ~ clustapp$Genres[6],
                                         cluster == 7 & Genres != clustapp$Genres[7] ~ clustapp$Genres[7],
                                         cluster == 8 & Genres != clustapp$Genres[8] ~ clustapp$Genres[8],
                                         cluster == 9 & Genres != clustapp$Genres[9] ~ clustapp$Genres[9],
                                         cluster == 10 & Genres != clustapp$Genres[10] ~ clustapp$Genres[10],
                                         TRUE ~ Genres)) -> apps3

```

```{r}
apps3 %>% group_by(True_Genre) %>% count()
```

##Regression Model with the new Genres:

```{r}
newreg = lm(Rating~SIZE+I(log(Installs))+I(log(Reviews))+`Last Update`+True_Genre+Price, data = apps3, weights = Installs)
summary(newreg)
```
```{r}
apps3 %>% filter(Rating >= 1 & Rating < 5) -> apps4 
reg1 = lm(Rating~SIZE+I(log(Installs))+I(log(Reviews))+`Last Update`+True_Genre-1+Price, data = apps4, weights = Installs)
summary(reg1)
```

```{r}
ggplot(reg1, aes(x=.fitted, y=.resid))+geom_point()+geom_smooth()
```
Making regression models for each genre of apps
```{r}

```

```{r}
apps4 %>% filter(True_Genre == "Action") %>% lm(Rating~SIZE+I(log(Installs))+I(log(Reviews))+`Last Update`+Price, data = ., weights = Installs) %>% tidy() 
apps4 %>% filter(True_Genre == "Business") %>% lm(Rating~SIZE+I(log(Installs))+I(log(Reviews))+`Last Update`+Price, data = ., weights = Installs) %>% tidy() 
apps4 %>% filter(True_Genre == "Dating") %>% lm(Rating~SIZE+I(log(Installs))+I(log(Reviews))+`Last Update`+Price, data = ., weights = Installs) %>% tidy() 
apps4 %>% filter(True_Genre == "Education") %>% lm(Rating~SIZE+I(log(Installs))+I(log(Reviews))+`Last Update`+Price, data = ., weights = Installs) %>% tidy() 
apps4 %>% filter(True_Genre == "Finance") %>% lm(Rating~SIZE+I(log(Installs))+I(log(Reviews))+`Last Update`+Price, data = ., weights = Installs) %>% tidy() 
apps4 %>% filter(True_Genre == "Health & Fitness") %>% lm(Rating~SIZE+I(log(Installs))+I(log(Reviews))+`Last Update`+Price, data = ., weights = Installs) %>% tidy() 
apps4 %>% filter(True_Genre == "Lifestyle") %>% lm(Rating~SIZE+I(log(Installs))+I(log(Reviews))+`Last Update`+Price, data = ., weights = Installs) %>% tidy() 
apps4 %>% filter(True_Genre == "Productivity") %>% lm(Rating~SIZE+I(log(Installs))+I(log(Reviews))+`Last Update`+Price, data = ., weights = Installs) %>% tidy() 
apps4 %>% filter(True_Genre == "Shopping") %>% lm(Rating~SIZE+I(log(Installs))+I(log(Reviews))+`Last Update`+Price, data = ., weights = Installs) %>% tidy() 
apps4 %>% filter(True_Genre == "Tools") %>% lm(Rating~SIZE+I(log(Installs))+I(log(Reviews))+`Last Update`+Price, data = ., weights = Installs) %>% tidy() 
```
```{r}
saveRDS(genres, file = "genres.rds")
```



##Sentiment Analysis
```{r}
reviews = read_csv("googleplaystore_user_reviews.csv")
(reviews = reviews %>% drop_na())
```

```{r}
reviews %>% ggplot(aes(x=Sentiment,y=Sentiment_Subjectivity))+geom_boxplot()
```

##Frequency of Words in Positive and Negative reviews
```{r}
(tidy_reviews <- reviews %>% filter(Sentiment != "Neutral") %>% group_by(Sentiment) %>% unnest_tokens(word,Translated_Review))
```

```{r}
#Counting the most common terms after filtering out common words
data("stop_words")
tidy_reviews = tidy_reviews %>% anti_join(stop_words)
```

```{r}
tidy_reviews %>% group_by(Sentiment) %>% count(word,sort = TRUE) %>% filter(n > 500) %>% 
  mutate(word=reorder(word,n)) %>% 
  ggplot(aes(word,n))+geom_col()+xlab(NULL)+coord_flip()
```

```{r}
frequency <- tidy_reviews %>% mutate(word1 = str_extract(word, "[a-z']+")) %>% 
  count(Sentiment,word1) %>% group_by(Sentiment) %>% 
  mutate(proportion = n/sum(n)) %>% 
  spread(Sentiment,proportion) %>% 
  gather(Sentiment, proportion,Positive:Negative)
```

```{r}
library(scales)

ggplot(frequency,aes(x=proportion,y=Sentiment,color=abs(Sentiment-proportion)))+geom_abline(color="gray40",lty=2)+
  geom_jitter(alpha = 0.1,size=2.5,width=0.3,height=0.3)+geom_text(aes(label = word),check_overlap = TRUE,vjust=1.5)+
  scale_x_log10(labels = percent_format()) + scale_y_log10(labels=percent_format())+scale_color_gradient(limits = c(0,0.001),low= "darkslategray4",high="gray75")+facet_wrap(~Sentiment,ncol=2)+theme(legend.position="none")+
  labs(y="Sentiment",x=NULL)
```

#WordCloud
```{r}
library(wordcloud)
```
```{r}
tidy_reviews %>% filter(Sentiment=="Positive") %>% count(word) %>% with(wordcloud(word,n,max.words = 175))
```
```{r}
tidy_reviews %>% filter(Sentiment=="Negative") %>% count(word) %>% with(wordcloud(word,n,max.words = 175))
```

